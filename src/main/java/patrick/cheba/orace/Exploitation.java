package patrick.cheba.orace;

import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.TextField;
import java.net.URL;
import java.sql.*;
import java.util.ResourceBundle;
import java.util.logging.Level;
import java.util.logging.Logger;
public class Exploitation implements Initializable {
    ObservableList<Object> options = FXCollections.observableArrayList();
    @FXML
    ComboBox<Object> comboBox = new ComboBox<>(options);
    @FXML
    private TextField exploi_name;
    String url = "jdbc:sqlite:dosage.db";
    @FXML
    public TextField nbr_pied;
    Connection con = null;
    Connection connect = null;
    PreparedStatement pst = null;
    PreparedStatement prepare = null;
    ResultSet rs = null ;
    @Override
    public void initialize(URL location, ResourceBundle resources) {
        remplirCombo();
    }

    /**
     * Avec la methode remplirCombo() nous recuperons les informations depuis la base de donnee sur la
     * table mesdosage pour emplir le comboBox et ici seule la culture est inserer dans le comboBox
     */

    public void remplirCombo(){
     try{
         con = DriverManager.getConnection(url);
         String query = "SELECT * FROM mesdosage WHERE UserName_id = ?";
         prepare = con.prepareStatement(query);
         prepare.setString(1,Global.userName);
         rs = prepare.executeQuery();
         while (rs.next()){
             if(!options.contains(rs.getString("Nom_de_plante"))) {
                 options.add(rs.getString("Nom_de_plante"));
             }
         }
         comboBox.setItems(options);
         prepare.close();
         con.close();
     } catch (SQLException e) {
         Logger.getLogger(Exploitation.class.getName()).log(Level.SEVERE,null,e);
     }
 }

    /**
     * Ici cette methode permet d'inserer dans la base de donnee les information de creation de
     * d'une exploitation apres remplissage des champs
     * @throws ClassNotFoundException
     * On declanche une exception de type ClassNotFoundException si la requete a echoue
     */
    String choix;
    @FXML
    void creer() throws ClassNotFoundException {

        try {
            Class.forName("org.sqlite.JDBC");
            String url = "jdbc:sqlite:dosage.db";
            con = DriverManager.getConnection(url);
            String sql = "INSERT INTO mesexploitation (NomExploitation, NombreDePieds,UserName_id,NomPlante) VALUES (?, ?,?,?)";
            pst = con.prepareStatement(sql);
            pst.setString(1,exploi_name.getText());
            pst.setString(2,nbr_pied.getText());
            pst.setString(3,Global.userName);
            choix = comboBox.getSelectionModel().getSelectedItem().toString();
            pst.setString(4,choix);
            pst.executeUpdate();
            pst.close();
            con.close();
            Alert alert = new Alert(Alert.AlertType.INFORMATION,"Votre exploitation est crée avec succes!", ButtonType.OK);
            alert.showAndWait();
        }catch (Exception e){
            System.out.println(e);
            Alert alert = new Alert(Alert.AlertType.WARNING,"Votre exploitation est non crée! Ces données sont déjà enregistré!", ButtonType.OK);
            alert.showAndWait();
        }
    }
}
